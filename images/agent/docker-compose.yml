# Agent container with Tailscale running directly (no sidecar)
# Build context is monorepo root to access packages/container-api
services:
  server:
    build:
      context: ../..
      dockerfile: images/agent/Dockerfile
      args:
        TZ: ${TZ:-UTC}
        GH_USERNAME: ${GH_USERNAME}
        GH_TOKEN: ${GH_TOKEN}
    image: agent-server:latest
    hostname: ${DEV_HOSTNAME:-dev-bun}
    container_name: ${DEV_HOSTNAME:-dev-bun}
    dns:
      # Use 1.1.1.1 first for external domains (returns IPv4, avoids IPv6 timeout issues)
      # MagicDNS (100.100.100.100) as fallback for Tailscale hostname resolution
      - 1.1.1.1
      - 100.100.100.100
    environment:
      - TS_AUTHKEY=${TS_AUTHKEY}
      - TS_HOSTNAME=${DEV_HOSTNAME:-dev-bun}
      - TS_EXTRA_ARGS=${TS_EXTRA_ARGS:---ssh}
      # Fixed WireGuard port enables direct connections from other LAN machines
      # Each container needs a unique port (generated by create-agent)
      - TS_WG_PORT=${TS_WG_PORT:-}
      - TS_TUN_NAME=${TS_TUN_NAME:-}
      - WORKSPACE_REPO=${WORKSPACE_REPO:-}
      - WORKSPACE_BRANCH=${WORKSPACE_BRANCH:-main}
      - GIT_EMAIL=${GIT_EMAIL:-agent@coordinator.local}
      - GIT_NAME=${GIT_NAME:-Agent}
      - DOTFILES_REPO=${DOTFILES_REPO:-cd-slash/dotfiles}
      - GH_USERNAME=${GH_USERNAME}
      - GH_TOKEN=${GH_TOKEN}
      # Manager WebSocket URL for container API to connect to
      - MANAGER_WS_URL=${MANAGER_WS_URL:-}
    volumes:
      - tailscale-data:/var/lib/tailscale
      - dotfiles:/root/.config/dotfiles
    devices:
      - /dev/net/tun:/dev/net/tun
    cap_add:
      - net_admin
    # Expose WireGuard port for direct Tailscale connections from other LAN machines
    ports:
      - "${TS_WG_PORT:-41641}:${TS_WG_PORT:-41641}/udp"
    restart: unless-stopped
    stdin_open: true
    tty: true
    # Hard memory limit to prevent container from consuming excessive host memory
    mem_limit: 4096m
    # Memory reservation (soft limit)
    mem_reservation: 3072m

volumes:
  tailscale-data:
  dotfiles:
    external: true
